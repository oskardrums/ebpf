<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Module ebpf_user</title>
<link rel="stylesheet" type="text/css" href="stylesheet.css" title="EDoc">
</head>
<body bgcolor="white">
<div class="navbar"><a name="#navbar_top"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<hr>

<h1>Module ebpf_user</h1>
<ul class="index"><li><a href="#description">Description</a></li><li><a href="#types">Data Types</a></li><li><a href="#index">Function Index</a></li><li><a href="#functions">Function Details</a></li></ul>   
Interactions with the eBPF system.
<p>Copyright Â© (C) 2021, moskar</p>

<p><b>Authors:</b> moskar (<a href="mailto:moskar.drummer@gmail.com"><tt>moskar.drummer@gmail.com</tt></a>).</p>

<h2><a name="description">Description</a></h2><p>   
Interactions with the eBPF system</p>
  
   <code>ebpf_user</code> contains functions that expose the Linux eBPF userspace API,
   including loading, verifying and applying eBPF programs, as well
   as creating and manipulating eBPF maps.
   For generating binary eBPF programs see <a href="ebpf_asm.html"><code>ebpf_asm</code></a> and <a href="ebpf_kern.html"><code>ebpf_kern</code></a>,
   but note that the functions in this module can work with any
   binary eBPF program, not only those created via <code>ebpf</code>.
  
<h2><a name="types">Data Types</a></h2>

<h3 class="typedecl"><a name="type-bpf_map">bpf_map()</a></h3>
<p><b>abstract datatype</b>: <tt>bpf_map()</tt></p>
<p>  An open eBPF map as returned by <a href="#create_map-4"><code>create_map/4</code></a>.</p>

<h3 class="typedecl"><a name="type-bpf_map_type">bpf_map_type()</a></h3>
<p><tt>bpf_map_type() = unspec | hash | array | prog_array | perf_event_array | percpu_hash | percpu_array | stack_trace | cgroup_array | lru_hash | lru_percpu_hash | lpm_trie | array_of_maps | hash_of_maps | devmap | sockmap | cpumap | xskmap | sockhash | cgroup_storage | reuseport_sockarray | percpu_cgroup_storage | queue | stack | sk_storage | devmap_hash | struct_ops | ringbuf | inode_storage | task_storage</tt></p>
<p>  An <code>atom</code> used to specify the type of an eBPF map, see <a href="#create_map-4"><code>create_map/4</code></a></p>

<h3 class="typedecl"><a name="type-bpf_prog">bpf_prog()</a></h3>
<p><b>abstract datatype</b>: <tt>bpf_prog()</tt></p>
<p>  A loaded eBPF program as returned by <a href="#load-2"><code>load/2</code></a>.</p>

<h3 class="typedecl"><a name="type-bpf_prog_type">bpf_prog_type()</a></h3>
<p><tt>bpf_prog_type() = unspec | socket_filter | kprobe | sched_cls | sched_act | tracepoint | xdp | perf_event | cgroup_skb | cgroup_sock | lwt_in | lwt_out | lwt_xmit | sock_ops | sk_skb | cgroup_device | sk_msg | raw_tracepoint | cgroup_sock_addr | lwt_seg6local | lirc_mode2 | sk_reuseport | flow_dissector | cgroup_sysctl | raw_tracepoint_writable | cgroup_sockopt | tracing | struct_ops | ext | lsm | sk_lookup</tt></p>
<p>  An <code>atom</code> used to specify the type of an eBPF program, see <a href="#load-2"><code>load/2</code></a>, <a href="#verify-2"><code>verify/2</code></a></p>

<h2><a name="index">Function Index</a></h2>
<table width="100%" border="1" cellspacing="0" cellpadding="2" summary="function index"><tr><td valign="top"><a href="#attach_socket_filter-2">attach_socket_filter/2</a></td><td>
  Applies a loaded eBPF program as returned by <a href="#load-2"><code>load/2</code></a> with
  <code>socket_filter</code> as <code>BpfProgramType</code> to a socket.</td></tr>
<tr><td valign="top"><a href="#attach_xdp-2">attach_xdp/2</a></td><td>
  Applies a loaded eBPF XDP program as returned by <a href="#load-2"><code>load/2</code></a>
  with <code>xdp</code> a <code>BpfProgramType</code> to a network interface.</td></tr>
<tr><td valign="top"><a href="#close-1">close/1</a></td><td>
  Closes an eBPF map or program.</td></tr>
<tr><td valign="top"><a href="#create_map-5">create_map/5</a></td><td>  
Creates a new eBPF map.</td></tr>
<tr><td valign="top"><a href="#delete_map_element-2">delete_map_element/2</a></td><td>
  Deletes the value associated with Key in eBPF map Map.</td></tr>
<tr><td valign="top"><a href="#detach_socket_filter-1">detach_socket_filter/1</a></td><td>
  Removes the eBPF program attached to <code>SockFd</code>.</td></tr>
<tr><td valign="top"><a href="#get_map_next_key-2">get_map_next_key/2</a></td><td>  
Retries the next key after Key in the eBPF map Map.</td></tr>
<tr><td valign="top"><a href="#load-2">load/2</a></td><td>  
Loads an eBPF program in binary form to the kernel.</td></tr>
<tr><td valign="top"><a href="#lookup_map_element-4">lookup_map_element/4</a></td><td>
  Retrieves the value associated with Key in eBPF map Map.</td></tr>
<tr><td valign="top"><a href="#test_program-4">test_program/4</a></td><td>  
Performs a test run of Prog with Data as input.</td></tr>
<tr><td valign="top"><a href="#update_map_element-4">update_map_element/4</a></td><td>
  Sets the value associated with Key in eBPF map Map to Value.</td></tr>
<tr><td valign="top"><a href="#verify-2">verify/2</a></td><td>
  same as <a href="#verify-3"><code>verify/3</code></a> with default options.</td></tr>
<tr><td valign="top"><a href="#verify-3">verify/3</a></td><td>  
Verifies an eBPF program in binary form with the kernel's verifier.</td></tr>
</table>

<h2><a name="functions">Function Details</a></h2>

<h3 class="function"><a name="attach_socket_filter-2">attach_socket_filter/2</a></h3>
<div class="spec">
<p><tt>attach_socket_filter(SockFd::non_neg_integer(), ProgFd::<a href="#type-bpf_prog">bpf_prog()</a>) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Applies a loaded eBPF program as returned by <a href="#load-2"><code>load/2</code></a> with
  <code>socket_filter</code> as <code>BpfProgramType</code> to a socket.</p>

<h3 class="function"><a name="attach_xdp-2">attach_xdp/2</a></h3>
<div class="spec">
<p><tt>attach_xdp(IfIndex::string() | non_neg_integer(), ProgFd::<a href="#type-bpf_prog">bpf_prog()</a>) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Applies a loaded eBPF XDP program as returned by <a href="#load-2"><code>load/2</code></a>
  with <code>xdp</code> a <code>BpfProgramType</code> to a network interface.</p>

<h3 class="function"><a name="close-1">close/1</a></h3>
<div class="spec">
<p><tt>close(Fd::<a href="#type-bpf_map">bpf_map()</a> | <a href="#type-bpf_prog">bpf_prog()</a>) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Closes an eBPF map or program.</p>

<h3 class="function"><a name="create_map-5">create_map/5</a></h3>
<div class="spec">
<p><tt>create_map(Type::<a href="#type-bpf_map_type">bpf_map_type()</a>, KeySize::integer(), ValueSize::integer(), MaxEntries::integer(), Flags::non_neg_integer()) -&gt; {ok, <a href="#type-bpf_map">bpf_map()</a>} | {error, atom()}</tt><br></p>
<p> </p>
</div><p><p>  
Creates a new eBPF map.</p>
 
  <p>If successful, the returned map can be passed to eBPF programs via
  <a href="ebpf_kern.html#ld_map_fd-2"><code>ebpf_kern:ld_map_fd/2</code></a> and manipulated from userspace via the
  <code>*_map_element</code> functions in this module.</p>
 
  KeySize and ValueSize are given in octets.</p>

<h3 class="function"><a name="delete_map_element-2">delete_map_element/2</a></h3>
<div class="spec">
<p><tt>delete_map_element(Map::<a href="#type-bpf_map">bpf_map()</a>, Key::binary()) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Deletes the value associated with Key in eBPF map Map.</p>

<h3 class="function"><a name="detach_socket_filter-1">detach_socket_filter/1</a></h3>
<div class="spec">
<p><tt>detach_socket_filter(SockFd::non_neg_integer()) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Removes the eBPF program attached to <code>SockFd</code>.</p>

<h3 class="function"><a name="get_map_next_key-2">get_map_next_key/2</a></h3>
<div class="spec">
<p><tt>get_map_next_key(Map::<a href="#type-bpf_map">bpf_map()</a>, Key::binary()) -&gt; {ok, binary()} | {error, atom()}</tt><br></p>
<p> </p>
</div><p><p>  
Retries the next key after Key in the eBPF map Map.</p>
 
  <p>If Key is not in Map, returns the first key in Map.</p>
 
  If Key is the last key in Map, returns <code>{error, enoent}</code>.</p>

<h3 class="function"><a name="load-2">load/2</a></h3>
<div class="spec">
<p><tt>load(BpfProgramType::<a href="#type-bpf_prog_type">bpf_prog_type()</a>, BpfProgramBin::binary()) -&gt; {ok, <a href="#type-bpf_prog">bpf_prog()</a>} | {error, atom()}</tt><br></p>
<p> </p>
</div><p><p>  
Loads an eBPF program in binary form to the kernel.</p>
 
  <p>The program is verified by the kernel's verifier before returning  
a handle to the loaded program to the caller.</p>
 
  If the an error is returned by this function, BpfProgramBin can be
  verified via <a href="#verify-2"><code>verify/2</code></a> for an informative error description.</p>

<h3 class="function"><a name="lookup_map_element-4">lookup_map_element/4</a></h3>
<div class="spec">
<p><tt>lookup_map_element(Map::<a href="#type-bpf_map">bpf_map()</a>, Key::binary(), ValueSize::non_neg_integer(), Flags::non_neg_integer()) -&gt; {ok, binary()} | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Retrieves the value associated with Key in eBPF map Map.</p>

<h3 class="function"><a name="test_program-4">test_program/4</a></h3>
<div class="spec">
<p><tt>test_program(Prog::<a href="#type-bpf_prog">bpf_prog()</a>, Repeat::integer(), Data::binary(), DataOutSize::non_neg_integer()) -&gt; {ok, Ret::non_neg_integer(), DataOut::binary(), Duration::non_neg_integer()} | {error, atom()}</tt><br></p>
<p> </p>
</div><p><p>  
Performs a test run of Prog with Data as input.</p>
 
  <p>WARNING: only use with trusted eBPF programs.
  This function uses the <code>BPF_PROG_TEST_RUN</code> Linux feature, which
  is unfortunately inherently unsafe if not used correctly. The way
  <code>BPF_PROG_TEST_RUN</code> works is that the kernel will write <code>DataOut</code>,
  created by applying <code>Prog</code> to <code>Data</code>, into a userspace buffer of some  
predetermined size, exposed in this function as DataOutSize.  
In most cases this is fine because Prog shouldn't create extensively large  
DataOut in normal use case, but in case where Prog might create an  
output that is larger DataOutSize, this can lead to buffer overflow.  
Hence the warning.</p>
 
  <p>If <code>DataOut</code> is not needed, <code>DataOutSize</code> can be safely set to <code>0</code>.</p>
 
  On success, returns the return value of <code>Prog(Data)</code>, as well as <code>DataOut</code>
  and the duration of the test as reported by the kernel.</p>

<h3 class="function"><a name="update_map_element-4">update_map_element/4</a></h3>
<div class="spec">
<p><tt>update_map_element(Map::<a href="#type-bpf_map">bpf_map()</a>, Key::binary(), Value::binary(), Flags::non_neg_integer()) -&gt; ok | {error, atom()}</tt><br></p>
<p> </p>
</div><p>
  Sets the value associated with Key in eBPF map Map to Value.</p>

<h3 class="function"><a name="verify-2">verify/2</a></h3>
<div class="spec">
<p><tt>verify(BpfProgramType::<a href="#type-bpf_prog_type">bpf_prog_type()</a>, BpfProgramBin::binary()) -&gt; {ok, string()} | {error, atom()} | {error, atom(), string()}</tt><br></p>
<p> </p>
</div><p>
  same as <a href="#verify-3"><code>verify/3</code></a> with default options.</p>

<h3 class="function"><a name="verify-3">verify/3</a></h3>
<div class="spec">
<p><tt>verify(BpfProgramType::<a href="#type-bpf_prog_type">bpf_prog_type()</a>, BpfProgramBin::binary(), Options::[{log_buffer_size, non_neg_integer()} | {kernel_version, non_neg_integer()} | {license, string()}]) -&gt; {ok, string()} | {error, atom()} | {error, atom(), string()}</tt><br></p>
<p> </p>
</div><p><p>  
Verifies an eBPF program in binary form with the kernel's verifier.</p>
 
  <p>If the program is deemed valid, the kernel reports a textual
  description of the verified program which is returned by this function
  as <code>{ok, Desc}</code>.</p>
 
  <p>If the program is deemed invalid, the kernel reports an error log
  which is returned as <code>{error, Errno, ErrorLog}</code>.
  Some errors, such as insufficient permissions, don't generate error logs.
  these error are returned as <code>{error, Errno}</code>.</p>
 
  The default values for unspecified options are:
  * {log_buffer_size, 4096}
  * {kernel_version, 0}
  * {license, "GPL"}</p>
<hr>

<div class="navbar"><a name="#navbar_bottom"></a><table width="100%" border="0" cellspacing="0" cellpadding="2" summary="navigation bar"><tr><td><a href="overview-summary.html" target="overviewFrame">Overview</a></td><td><a href="http://www.erlang.org/"><img src="erlang.png" align="right" border="0" alt="erlang logo"></a></td></tr></table></div>
<p><i>Generated by EDoc</i></p>
</body>
</html>
